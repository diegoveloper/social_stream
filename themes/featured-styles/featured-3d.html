<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Featured Message - 3D Styles</title>
    <link rel="icon" href="../../favicon.ico" />
    <link rel="preload" href="../../thirdparty/NotoColorEmoji.ttf" as="font" type="font/ttf" crossorigin="anonymous">
    <style>
        @font-face {
            font-family: NotoColorEmojiLimited;
            unicode-range: U+1F1E6-1F1FF;
            src: url(../../thirdparty/NotoColorEmoji.ttf);
        }

        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Bebas+Neue&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Orbitron', monospace, 'NotoColorEmojiLimited';
            background: transparent;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            perspective: 1000px;
        }

        #stage {
            width: 90%;
            max-width: 1000px;
            height: 400px;
            position: relative;
            transform-style: preserve-3d;
        }

        /* Style 1: Rotating Cube */
        .style-cube .message-wrapper {
            width: 100%;
            height: 300px;
            position: relative;
            transform-style: preserve-3d;
            animation: rotateCube 20s infinite linear;
        }

        .style-cube .face {
            position: absolute;
            width: 100%;
            height: 100%;
            background: rgba(0, 20, 40, 0.9);
            border: 2px solid #00ffff;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px;
            backface-visibility: visible;
        }

        .style-cube .face.front { transform: translateZ(150px); }
        .style-cube .face.back { transform: rotateY(180deg) translateZ(150px); }
        .style-cube .face.right { transform: rotateY(90deg) translateZ(150px); }
        .style-cube .face.left { transform: rotateY(-90deg) translateZ(150px); }
        .style-cube .face.top { transform: rotateX(90deg) translateZ(150px); }
        .style-cube .face.bottom { transform: rotateX(-90deg) translateZ(150px); }

        @keyframes rotateCube {
            0% { transform: rotateX(0) rotateY(0); }
            100% { transform: rotateX(360deg) rotateY(360deg); }
        }

        /* Style 2: Card Flip */
        .style-flip .message-wrapper {
            width: 100%;
            height: 350px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.8s;
        }

        .style-flip .message-wrapper.show {
            animation: flipIn 0.8s ease-out;
        }

        .style-flip .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        }

        .style-flip .front {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: 900;
            text-transform: uppercase;
        }

        .style-flip .back {
            background: #1a1a1a;
            color: white;
            transform: rotateY(180deg);
            padding: 30px;
        }

        @keyframes flipIn {
            0% { transform: rotateY(-180deg) scale(0.8); }
            100% { transform: rotateY(0) scale(1); }
        }

        /* Style 3: Floating Panels */
        .style-float .message-wrapper {
            position: relative;
            transform-style: preserve-3d;
            animation: float 6s ease-in-out infinite;
        }

        .style-float .panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 30px;
            position: absolute;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .style-float .panel:nth-child(1) {
            transform: translateZ(0px);
            width: 100%;
        }

        .style-float .panel:nth-child(2) {
            transform: translateZ(-50px) translateX(20px) translateY(20px);
            opacity: 0.6;
            width: 100%;
        }

        .style-float .panel:nth-child(3) {
            transform: translateZ(-100px) translateX(40px) translateY(40px);
            opacity: 0.3;
            width: 100%;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotateX(0) rotateY(0); }
            25% { transform: translateY(-20px) rotateX(5deg) rotateY(5deg); }
            50% { transform: translateY(0) rotateX(-5deg) rotateY(-5deg); }
            75% { transform: translateY(20px) rotateX(5deg) rotateY(-5deg); }
        }

        /* Style 4: Helix */
        .style-helix .message-wrapper {
            position: relative;
            width: 100%;
            height: 400px;
            transform-style: preserve-3d;
            animation: helixRotate 10s linear infinite;
        }

        .style-helix .helix-item {
            position: absolute;
            width: 80%;
            left: 10%;
            background: linear-gradient(45deg, #f72585, #7209b7, #3a0ca3, #4361ee);
            padding: 20px;
            border-radius: 10px;
            color: white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        @keyframes helixRotate {
            0% { transform: rotateY(0); }
            100% { transform: rotateY(360deg); }
        }

        /* Style 5: Isometric */
        .style-iso .message-wrapper {
            transform: rotateX(30deg) rotateY(-45deg);
            transform-style: preserve-3d;
            animation: isoFloat 4s ease-in-out infinite;
        }

        .style-iso .iso-box {
            width: 600px;
            height: 200px;
            position: relative;
            transform-style: preserve-3d;
            margin: 0 auto;
        }

        .style-iso .iso-face {
            position: absolute;
            background: #2a2a2a;
            border: 1px solid #444;
            display: flex;
            align-items: center;
            padding: 20px;
        }

        .style-iso .iso-face.front {
            width: 600px;
            height: 200px;
            transform: translateZ(100px);
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
        }

        .style-iso .iso-face.right {
            width: 200px;
            height: 200px;
            transform: rotateY(90deg) translateZ(300px);
            background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
        }

        .style-iso .iso-face.top {
            width: 600px;
            height: 200px;
            transform: rotateX(90deg) translateZ(100px);
            background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
        }

        @keyframes isoFloat {
            0%, 100% { transform: rotateX(30deg) rotateY(-45deg) translateY(0); }
            50% { transform: rotateX(30deg) rotateY(-45deg) translateY(-20px); }
        }

        /* Common message styling */
        .message {
            display: flex;
            align-items: center;
            gap: 20px;
            color: white;
        }

        .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .content {
            flex: 1;
        }

        .username {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #00ffff;
            text-shadow: 0 0 10px currentColor;
        }

        .text {
            font-size: 18px;
            line-height: 1.5;
            color: #f0f0f0;
        }

        .badges {
            display: inline-flex;
            gap: 6px;
            margin-left: 10px;
        }

        .badge {
            height: 22px;
        }

        /* Exit animations */
        .message-wrapper.exit {
            animation: exitScale 0.6s ease-in forwards;
        }

        @keyframes exitScale {
            to {
                opacity: 0;
                transform: scale(0) rotateX(90deg);
            }
        }

        /* Hide on load */
        .message-wrapper {
            opacity: 0;
            animation-fill-mode: forwards;
        }

        .message-wrapper.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div id="stage">
        <div id="output"></div>
    </div>

    <script src="../../tts.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const roomID = urlParams.get('session') || urlParams.get('room') || 'TESTROOM';
        const style = urlParams.get('style') || 'cube'; // cube, flip, float, helix, iso
        const password = urlParams.get('password') || '';
        const showtime = parseInt(urlParams.get('showtime') || '8000');
        
        document.body.className = `style-${style}`;
        
        let messageTimeout = null;
        let currentMessage = null;

        // Create iframe
        function createIframe() {
            const iframe = document.createElement('iframe');
            iframe.src = `https://vdo.socialstream.ninja/?ln&password=${password}&salt=vdo.ninja&label=featured-3d&exclude=${roomID}&scene&novideo&noaudio&cleanoutput&room=${roomID}`;
            iframe.style.cssText = 'width:0;height:0;position:fixed;left:-100px;top:-100px;';
            iframe.id = 'vdoninja';
            iframe.allow = 'microphone';
            document.body.appendChild(iframe);

            window.addEventListener('message', function(e) {
                if (e.source !== iframe.contentWindow) return;
                if (e.data.dataReceived && e.data.dataReceived.overlayNinja) {
                    processMessage(e.data.dataReceived.overlayNinja);
                }
            });
        }

        function processMessage(data) {
            if (!data || data === false || (data.contents === false)) {
                hideMessage();
                return;
            }
            if (data && data.contents) {
                showMessage(data.contents);
            }
        }

        function showMessage(content) {
            if (!content.chatmessage && !content.chatname) return;

            hideMessage(() => {
                const wrapper = document.createElement('div');
                wrapper.className = 'message-wrapper';

                if (style === 'cube') {
                    // Create cube faces
                    ['front', 'back', 'left', 'right', 'top', 'bottom'].forEach(face => {
                        const div = document.createElement('div');
                        div.className = 'face ' + face;
                        div.appendChild(createMessage(content));
                        wrapper.appendChild(div);
                    });
                } else if (style === 'flip') {
                    // Create card faces
                    const front = document.createElement('div');
                    front.className = 'card-face front';
                    front.textContent = 'NEW MESSAGE!';
                    
                    const back = document.createElement('div');
                    back.className = 'card-face back';
                    back.appendChild(createMessage(content));
                    
                    wrapper.appendChild(front);
                    wrapper.appendChild(back);
                    
                    setTimeout(() => {
                        wrapper.style.transform = 'rotateY(180deg)';
                    }, 800);
                } else if (style === 'float') {
                    // Create floating panels
                    for (let i = 0; i < 3; i++) {
                        const panel = document.createElement('div');
                        panel.className = 'panel';
                        if (i === 0) {
                            panel.appendChild(createMessage(content));
                        }
                        wrapper.appendChild(panel);
                    }
                } else if (style === 'helix') {
                    // Create helix structure
                    const angles = [0, 120, 240];
                    angles.forEach((angle, i) => {
                        const item = document.createElement('div');
                        item.className = 'helix-item';
                        item.style.transform = `rotateY(${angle}deg) translateZ(200px)`;
                        if (i === 0) {
                            item.appendChild(createMessage(content));
                        }
                        wrapper.appendChild(item);
                    });
                } else if (style === 'iso') {
                    // Create isometric box
                    const box = document.createElement('div');
                    box.className = 'iso-box';
                    
                    ['front', 'right', 'top'].forEach(face => {
                        const div = document.createElement('div');
                        div.className = 'iso-face ' + face;
                        if (face === 'front') {
                            div.appendChild(createMessage(content));
                        }
                        box.appendChild(div);
                    });
                    
                    wrapper.appendChild(box);
                }

                document.getElementById('output').appendChild(wrapper);
                currentMessage = wrapper;

                requestAnimationFrame(() => {
                    wrapper.classList.add('show');
                });

                // TTS
                if (window.speak && urlParams.has('tts')) {
                    const text = content.chatmessage ? content.chatmessage.replace(/<[^>]*>/g, '') : '';
                    if (text) window.speak(content.chatname + ' says ' + text);
                }

                if (messageTimeout) clearTimeout(messageTimeout);
                messageTimeout = setTimeout(hideMessage, showtime);
            });
        }

        function createMessage(content) {
            const message = document.createElement('div');
            message.className = 'message';

            if (content.chatimg) {
                const avatar = document.createElement('img');
                avatar.className = 'avatar';
                avatar.src = content.chatimg;
                avatar.onerror = () => { avatar.src = '../../sources/images/unknown.png'; };
                message.appendChild(avatar);
            }

            const div = document.createElement('div');
            div.className = 'content';

            const header = document.createElement('div');
            
            const username = document.createElement('span');
            username.className = 'username';
            username.textContent = content.chatname || 'Anonymous';
            header.appendChild(username);

            if (content.chatbadges && Array.isArray(content.chatbadges)) {
                const badges = document.createElement('span');
                badges.className = 'badges';
                content.chatbadges.forEach(badge => {
                    if (typeof badge === 'string') {
                        const img = document.createElement('img');
                        img.className = 'badge';
                        img.src = badge;
                        badges.appendChild(img);
                    }
                });
                header.appendChild(badges);
            }

            div.appendChild(header);

            if (content.chatmessage) {
                const text = document.createElement('div');
                text.className = 'text';
                text.innerHTML = content.chatmessage;
                div.appendChild(text);
            }

            message.appendChild(div);
            return message;
        }

        function hideMessage(callback) {
            if (messageTimeout) {
                clearTimeout(messageTimeout);
                messageTimeout = null;
            }

            if (currentMessage) {
                currentMessage.classList.add('exit');
                setTimeout(() => {
                    if (currentMessage && currentMessage.parentNode) {
                        currentMessage.parentNode.removeChild(currentMessage);
                    }
                    currentMessage = null;
                    if (callback) callback();
                }, 600);
            } else if (callback) {
                callback();
            }
        }

        // Initialize TTS
        if (urlParams.has('tts') && window.initTTS) {
            window.initTTS({
                lang: urlParams.get('tts') || 'en-US',
                pitch: parseFloat(urlParams.get('pitch') || '1'),
                rate: parseFloat(urlParams.get('rate') || '1')
            });
        }

        createIframe();
    </script>
</body>
</html>