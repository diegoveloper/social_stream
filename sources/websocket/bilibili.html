<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bilibili Live Chat WebSocket Client</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .container {
            display: flex;
            gap: 20px;
        }
        
        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .config-panel {
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .message-panel {
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            height: 400px;
            overflow-y: auto;
        }
        
        .system-panel {
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 5px;
            height: 200px;
            overflow-y: auto;
        }
        
        .info-panel {
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            height: 200px;
            overflow-y: auto;
        }
        
        h3 {
            margin-top: 0;
        }
        
        .input-group {
            margin-bottom: 10px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
        }
        
        .input-group input, .input-group textarea {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        
        button {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        
        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .username {
            font-weight: bold;
            color: #2196F3;
        }
        
        .message-time {
            margin-left: auto;
            color: #777;
            font-size: 0.85em;
        }
        
        .message-content {
            color: #333;
        }
        
        .gift-message {
            background-color: #FFF8E1;
        }
        
        .entry-message {
            background-color: #E8F5E9;
        }
        
        .super-chat {
            background-color: #FFEBEE;
        }
        
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        
        .system-log {
            margin-bottom: 5px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .error {
            color: #f44336;
        }
        
        .warning {
            color: #ff9800;
        }
        
        .info {
            color: #2196F3;
        }
        
        .room-info {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .room-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            margin-right: 15px;
        }
        
        .room-title {
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .stats {
            display: flex;
            gap: 15px;
            margin-top: 5px;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
        }
        
        .stat-item i {
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <h1>Bilibili Live Chat WebSocket Client</h1>
    
    <div class="container">
        <div class="left-panel">
            <div class="config-panel">
                <h3>Configuration</h3>
                <div class="input-group">
                    <label for="roomId">Room ID:</label>
                    <input type="text" id="roomId" placeholder="Enter Bilibili room ID">
                </div>
                <div class="input-group">
                    <label for="cookie">Cookie (Optional, for sending messages):</label>
                    <textarea id="cookie" placeholder="SESSDATA=xxx; bili_jct=xxx; buvid3=xxx"></textarea>
                </div>
                <button id="connectBtn">Connect</button>
                <button id="disconnectBtn" disabled>Disconnect</button>
            </div>
            
            <div class="message-panel" id="messageContainer">
                <h3>Chat Messages</h3>
                <!-- Messages will be displayed here -->
            </div>
        </div>
        
        <div class="right-panel">
            <div class="info-panel" id="roomInfoContainer">
                <h3>Room Information</h3>
                <div id="roomInfo">
                    <!-- Room info will be displayed here -->
                </div>
            </div>
            
            <div class="system-panel" id="systemLogContainer">
                <h3>System Logs</h3>
                <div id="systemLog">
                    <!-- System logs will be displayed here -->
                </div>
            </div>
            
            <div class="input-group" style="margin-top: 20px;">
                <label for="messageInput">Send Message:</label>
                <input type="text" id="messageInput" placeholder="Enter message to send" disabled>
                <button id="sendBtn" disabled>Send</button>
            </div>
        </div>
    </div>

    <script>
        // Constants for WebSocket protocol
        const WS_OP_HEARTBEAT = 2;          // Heartbeat
        const WS_OP_HEARTBEAT_REPLY = 3;    // Heartbeat response
        const WS_OP_MESSAGE = 5;            // Messages, gifts, etc.
        const WS_OP_USER_AUTHENTICATION = 7; // Authentication
        const WS_OP_CONNECT_SUCCESS = 8;    // Connection confirmation
        
        const WS_BODY_PROTOCOL_NORMAL = 0;  // Normal messages
        const WS_BODY_PROTOCOL_ZLIB = 2;    // Zlib compressed messages
        const WS_BODY_PROTOCOL_BROTLI = 3;  // Brotli compressed messages
        
        const WS_HEADER_SIZE = 16;          // Header size in bytes
        
        // Command types
        const CMD_DANMU_MSG = "DANMU_MSG";  // Chat message
        const CMD_SEND_GIFT = "SEND_GIFT";  // Gift
        const CMD_WELCOME = "WELCOME";      // User welcome
        const CMD_WELCOME_GUARD = "WELCOME_GUARD"; // Guard welcome
        const CMD_SUPER_CHAT_MESSAGE = "SUPER_CHAT_MESSAGE"; // Super chat
        const CMD_INTERACT_WORD = "INTERACT_WORD"; // User interactions
        
        class BilibiliLiveClient {
            constructor(roomId, cookie = "") {
                this.roomId = roomId;
                this.cookie = cookie;
                this.realRoomId = null;
                this.socket = null;
                this.heartbeatInterval = null;
                this.connected = false;
                this.listeners = {
                    message: [],
                    gift: [],
                    superChat: [],
                    userEnter: [],
                    roomInfo: [],
                    log: [],
                    error: [],
                    connection: []
                };
            }
            
            async connect() {
                try {
                    // Get real room ID and WebSocket connection info
                    await this.getRoomInfo();
                    
                    // Connect to WebSocket server
                    const wsUrl = await this.getWebSocketUrl();
                    this.log(`Connecting to WebSocket server: ${wsUrl}`);
                    
                    this.socket = new WebSocket(wsUrl);
                    this.socket.binaryType = "arraybuffer";
                    
                    this.socket.onopen = () => this.onOpen();
                    this.socket.onmessage = (event) => this.onMessage(event);
                    this.socket.onclose = () => this.onClose();
                    this.socket.onerror = (error) => this.onError(error);
                    
                    return true;
                } catch (error) {
                    this.error(`Connection error: ${error.message}`);
                    return false;
                }
            }
            
            disconnect() {
                if (this.socket) {
                    this.log("Disconnecting from WebSocket server");
                    clearInterval(this.heartbeatInterval);
                    this.socket.close();
                    this.socket = null;
                    this.connected = false;
                    this.trigger('connection', { connected: false });
                }
            }
            
            async getRoomInfo() {
                try {
                    const response = await fetch(`https://api.live.bilibili.com/room/v1/Room/room_init?id=${this.roomId}`);
                    const data = await response.json();
                    
                    if (data.code === 0) {
                        this.realRoomId = data.data.room_id;
                        const uid = data.data.uid;
                        
                        this.log(`Got real room ID: ${this.realRoomId}`);
                        
                        // Get additional room info
                        const roomInfoResponse = await fetch(`https://api.live.bilibili.com/xlive/web-room/v1/index/getInfoByRoom?room_id=${this.realRoomId}`);
                        const roomInfoData = await roomInfoResponse.json();
                        
                        if (roomInfoData.code === 0) {
                            const roomInfo = {
                                roomId: this.realRoomId,
                                title: roomInfoData.data.room_info.title,
                                cover: roomInfoData.data.room_info.cover,
                                online: roomInfoData.data.room_info.online,
                                anchor: {
                                    uid: roomInfoData.data.room_info.uid,
                                    name: roomInfoData.data.anchor_info.base_info.uname,
                                    face: roomInfoData.data.anchor_info.base_info.face
                                },
                                area: {
                                    name: roomInfoData.data.room_info.area_name,
                                    parentName: roomInfoData.data.room_info.parent_area_name
                                }
                            };
                            
                            this.trigger('roomInfo', roomInfo);
                        }
                        
                        return this.realRoomId;
                    } else {
                        throw new Error(`Failed to get room info: ${data.message}`);
                    }
                } catch (error) {
                    this.error(`Failed to get room info: ${error.message}`);
                    throw error;
                }
            }
            
            async getWebSocketUrl() {
                try {
                    const response = await fetch(`https://api.live.bilibili.com/xlive/web-room/v1/index/getDanmuInfo?id=${this.realRoomId}&type=0`);
                    const data = await response.json();
                    
                    if (data.code === 0) {
                        this.token = data.data.token;
                        const hostList = data.data.host_list;
                        const host = hostList[0]; // Use the first host
                        
                        return `wss://${host.host}:${host.wss_port}/sub`;
                    } else {
                        throw new Error(`Failed to get WebSocket URL: ${data.message}`);
                    }
                } catch (error) {
                    this.error(`Failed to get WebSocket URL: ${error.message}`);
                    throw error;
                }
            }
            
            onOpen() {
                this.log("WebSocket connection established");
                
                // Send authentication packet
                this.sendAuthPacket();
                
                // Start sending heartbeats
                this.heartbeatInterval = setInterval(() => this.sendHeartbeat(), 30000);
                
                this.connected = true;
                this.trigger('connection', { connected: true });
            }
            
            onMessage(event) {
                const data = new Uint8Array(event.data);
                this.parseMessage(data);
            }
            
            onClose() {
                this.log("WebSocket connection closed");
                clearInterval(this.heartbeatInterval);
                this.connected = false;
                this.trigger('connection', { connected: false });
            }
            
            onError(error) {
                this.error(`WebSocket error: ${error}`);
                this.trigger('error', error);
            }
            
            sendAuthPacket() {
                const authPacket = {
                    uid: 0,
                    roomid: this.realRoomId,
                    protover: 2,  // Use zlib compression
                    platform: "web",
                    type: 2,
                    key: this.token
                };
                
                const packet = this.createPacket(WS_OP_USER_AUTHENTICATION, JSON.stringify(authPacket));
                this.socket.send(packet);
                this.log("Sent authentication packet");
            }
            
            sendHeartbeat() {
                const packet = this.createPacket(WS_OP_HEARTBEAT, "");
                this.socket.send(packet);
                this.log("Sent heartbeat");
            }
            
            createPacket(operation, body) {
                const bodyData = typeof body === 'string' ? new TextEncoder().encode(body) : body;
                const packetLength = WS_HEADER_SIZE + bodyData.length;
                
                // Create header
                const header = new ArrayBuffer(WS_HEADER_SIZE);
                const headerView = new DataView(header);
                
                // Packet Length (4 bytes)
                headerView.setUint32(0, packetLength);
                // Header Length (2 bytes)
                headerView.setUint16(4, WS_HEADER_SIZE);
                // Protocol Version (2 bytes)
                headerView.setUint16(6, 1);
                // Operation (4 bytes)
                headerView.setUint32(8, operation);
                // Sequence ID (4 bytes)
                headerView.setUint32(12, 1);
                
                // Combine header and body
                const packet = new Uint8Array(packetLength);
                packet.set(new Uint8Array(header), 0);
                packet.set(bodyData, WS_HEADER_SIZE);
                
                return packet.buffer;
            }
            
            parseMessage(data) {
                try {
                    const headerView = new DataView(data.buffer);
                    const packetLength = headerView.getUint32(0);
                    const headerLength = headerView.getUint16(4);
                    const protocolVersion = headerView.getUint16(6);
                    const operation = headerView.getUint32(8);
                    const sequenceId = headerView.getUint32(12);
                    
                    // Extract packet body
                    const body = data.slice(headerLength);
                    
                    switch (operation) {
                        case WS_OP_CONNECT_SUCCESS:
                            this.log("Authentication successful");
                            break;
                            
                        case WS_OP_HEARTBEAT_REPLY:
                            // Parse popularity value (usually a 4-byte integer)
                            const popularity = new DataView(body.buffer).getUint32(0);
                            this.log(`Heartbeat reply: ${popularity} online users`);
                            this.trigger('roomInfo', { online: popularity });
                            break;
                            
                        case WS_OP_MESSAGE:
                            this.handleDataPacket(protocolVersion, body);
                            break;
                            
                        default:
                            this.log(`Unknown operation: ${operation}`);
                    }
                } catch (error) {
                    this.error(`Failed to parse message: ${error.message}`);
                }
            }
            
            handleDataPacket(version, data) {
                try {
                    let messageData;
                    
                    // Handle different protocol versions
                    if (version === WS_BODY_PROTOCOL_ZLIB) {
                        // Decompress using zlib (via pako)
                        messageData = pako.inflate(data);
                        
                        // If message contains multiple packets, process each one
                        if (messageData.length > 0) {
                            this.handleMultipleMessages(messageData);
                            return;
                        }
                    } else if (version === WS_BODY_PROTOCOL_BROTLI) {
                        // Brotli decompression is not supported in this implementation
                        this.error("Brotli decompression is not supported");
                        return;
                    } else {
                        messageData = data;
                    }
                    
                    // Parse the message data as JSON
                    const jsonStr = new TextDecoder().decode(messageData);
                    const jsonData = JSON.parse(jsonStr);
                    
                    // Process the command
                    this.processCommand(jsonData);
                } catch (error) {
                    this.error(`Failed to handle data packet: ${error.message}`);
                }
            }
            
            handleMultipleMessages(data) {
                try {
                    let offset = 0;
                    
                    while (offset < data.length) {
                        // Parse packet header
                        const headerView = new DataView(data.buffer, data.byteOffset + offset);
                        const packetLength = headerView.getUint32(0);
                        const headerLength = headerView.getUint16(4);
                        const protocolVersion = headerView.getUint16(6);
                        const operation = headerView.getUint32(8);
                        
                        // Extract packet body
                        const body = data.slice(offset + headerLength, offset + packetLength);
                        
                        // Process based on operation type
                        if (operation === WS_OP_MESSAGE) {
                            const jsonStr = new TextDecoder().decode(body);
                            try {
                                const jsonData = JSON.parse(jsonStr);
                                this.processCommand(jsonData);
                            } catch (e) {
                                // Skip malformed JSON
                            }
                        }
                        
                        // Move to the next packet
                        offset += packetLength;
                    }
                } catch (error) {
                    this.error(`Failed to handle multiple messages: ${error.message}`);
                }
            }
            
            processCommand(data) {
                const cmd = data.cmd || "";
                
                // Handle different command types
                if (cmd.startsWith(CMD_DANMU_MSG)) {
                    // Chat message
                    const info = data.info;
                    const message = {
                        type: 'message',
                        text: info[1],
                        userId: info[2][0],
                        username: info[2][1],
                        isAdmin: info[2][2] === 1,
                        isVIP: info[2][3] === 1,
                        isSVIP: info[2][4] === 1,
                        medal: info[3] ? {
                            level: info[3][0],
                            name: info[3][1],
                            ownerName: info[3][2],
                            roomId: info[3][3],
                            color: info[3][4],
                            specialColor: info[3][5]
                        } : null,
                        userLevel: info[4][0],
                        timestamp: info[0][4],
                        dmID: info[0][5]
                    };
                    
                    // Try to get avatar URL if available
                    if (data.dm_v2) {
                        try {
                            const dmV2 = JSON.parse(data.dm_v2);
                            if (dmV2.user && dmV2.user.face) {
                                message.avatar = dmV2.user.face;
                            }
                        } catch (e) {
                            // Ignore parsing errors
                        }
                    }
                    
                    this.trigger('message', message);
                    
                } else if (cmd === CMD_SEND_GIFT) {
                    // Gift
                    const giftData = data.data;
                    const gift = {
                        type: 'gift',
                        userId: giftData.uid,
                        username: giftData.uname,
                        avatar: giftData.face,
                        giftId: giftData.giftId,
                        giftName: giftData.giftName,
                        price: giftData.price,
                        num: giftData.num,
                        timestamp: giftData.timestamp,
                        action: giftData.action
                    };
                    
                    this.trigger('gift', gift);
                    
                } else if (cmd === CMD_SUPER_CHAT_MESSAGE) {
                    // Super Chat
                    const scData = data.data;
                    const superChat = {
                        type: 'superChat',
                        userId: scData.uid,
                        username: scData.user_info.uname,
                        avatar: scData.user_info.face,
                        message: scData.message,
                        price: scData.price,
                        startTime: scData.start_time,
                        endTime: scData.end_time,
                        time: scData.time,
                        color: scData.background_color
                    };
                    
                    this.trigger('superChat', superChat);
                    
                } else if (cmd === CMD_INTERACT_WORD) {
                    // User interactions (e.g., entering the room)
                    const userInfo = data.data;
                    const userInteraction = {
                        type: 'userEnter',
                        userId: userInfo.uid,
                        username: userInfo.uname,
                        timestamp: userInfo.timestamp,
                        medalInfo: userInfo.fans_medal ? {
                            level: userInfo.fans_medal.medal_level,
                            name: userInfo.fans_medal.medal_name,
                            anchorUsername: userInfo.fans_medal.anchor_uname,
                            anchorRoomId: userInfo.fans_medal.anchor_roomid
                        } : null
                    };
                    
                    this.trigger('userEnter', userInteraction);
                    
                } else if (cmd === CMD_WELCOME || cmd === CMD_WELCOME_GUARD) {
                    // User welcome
                    const welcomeData = data.data;
                    const welcome = {
                        type: 'welcome',
                        userId: welcomeData.uid,
                        username: welcomeData.uname,
                        isAdmin: welcomeData.is_admin === 1,
                        isGuard: cmd === CMD_WELCOME_GUARD
                    };
                    
                    this.trigger('userEnter', welcome);
                }
                // Other command types can be added as needed
            }
            
            async sendMessage(text) {
                if (!this.connected || !this.cookie) {
                    this.error("Cannot send message: Not connected or no cookie provided");
                    return false;
                }
                
                // Parse cookie to get SESSDATA and bili_jct
                const cookies = this.parseCookie(this.cookie);
                const sessdata = cookies.SESSDATA;
                const csrf = cookies.bili_jct;
                
                if (!sessdata || !csrf) {
                    this.error("Cannot send message: Missing SESSDATA or bili_jct in cookie");
                    return false;
                }
                
                try {
                    const form = new FormData();
                    form.append('color', '16777215'); // White color
                    form.append('fontsize', '25');
                    form.append('mode', '1');
                    form.append('msg', text);
                    form.append('roomid', this.realRoomId);
                    form.append('rnd', Math.floor(Date.now() / 1000));
                    form.append('csrf', csrf);
                    form.append('csrf_token', csrf);
                    
                    const response = await fetch('https://api.live.bilibili.com/msg/send', {
                        method: 'POST',
                        body: form,
                        headers: {
                            'Cookie': this.cookie
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.code === 0) {
                        this.log("Message sent successfully");
                        return true;
                    } else {
                        this.error(`Failed to send message: ${result.message}`);
                        return false;
                    }
                } catch (error) {
                    this.error(`Failed to send message: ${error.message}`);
                    return false;
                }
            }
            
            parseCookie(cookieStr) {
                const result = {};
                const cookies = cookieStr.split(';');
                
                for (let cookie of cookies) {
                    const parts = cookie.trim().split('=');
                    if (parts.length === 2) {
                        result[parts[0]] = parts[1];
                    }
                }
                
                return result;
            }
            
            // Event handling methods
            on(event, callback) {
                if (this.listeners[event]) {
                    this.listeners[event].push(callback);
                }
                return this;
            }
            
            off(event, callback) {
                if (this.listeners[event]) {
                    this.listeners[event] = this.listeners[event].filter(cb => cb !== callback);
                }
                return this;
            }
            
            trigger(event, data) {
                if (this.listeners[event]) {
                    for (const callback of this.listeners[event]) {
                        callback(data);
                    }
                }
            }
            
            log(message) {
                console.log(message);
                this.trigger('log', { type: 'info', message });
            }
            
            error(message) {
                console.error(message);
                this.trigger('log', { type: 'error', message });
                this.trigger('error', { message });
            }
        }
        
        // UI management
        document.addEventListener('DOMContentLoaded', function() {
            let client = null;
            
            const roomIdInput = document.getElementById('roomId');
            const cookieInput = document.getElementById('cookie');
            const messageInput = document.getElementById('messageInput');
            const messageContainer = document.getElementById('messageContainer');
            const systemLogContainer = document.getElementById('systemLog');
            const roomInfoContainer = document.getElementById('roomInfo');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const sendBtn = document.getElementById('sendBtn');
            
            // Connect button click handler
            connectBtn.addEventListener('click', async function() {
                const roomId = roomIdInput.value.trim();
                if (!roomId) {
                    addSystemLog('error', 'Please enter a room ID');
                    return;
                }
                
                // Disable connect button during connection
                connectBtn.disabled = true;
                
                // Create new client
                client = new BilibiliLiveClient(roomId, cookieInput.value.trim());
                
                // Set up event listeners
                client.on('message', handleMessage);
                client.on('gift', handleGift);
                client.on('superChat', handleSuperChat);
                client.on('userEnter', handleUserEnter);
                client.on('roomInfo', handleRoomInfo);
                client.on('log', handleLog);
                client.on('error', handleError);
                client.on('connection', handleConnection);
                
                // Connect to WebSocket server
                const connected = await client.connect();
                
                if (!connected) {
                    connectBtn.disabled = false;
                }
            });
            
            // Disconnect button click handler
            disconnectBtn.addEventListener('click', function() {
                if (client) {
                    client.disconnect();
                }
            });
            
            // Send button click handler
            sendBtn.addEventListener('click', function() {
                const message = messageInput.value.trim();
                if (!message) return;
                
                if (client && client.connected) {
                    client.sendMessage(message);
                    messageInput.value = '';
                }
            });
            
            // Also send on Enter key
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendBtn.click();
                }
            });
            
            // Handle messages from the server
            function handleMessage(message) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                
                const header = document.createElement('div');
                header.className = 'message-header';
                
                if (message.avatar) {
                    const avatar = document.createElement('img');
                    avatar.className = 'avatar';
                    avatar.src = message.avatar;
                    avatar.onerror = function() {
                        this.src = 'https://static.hdslb.com/images/member/noface.gif';
                    };
                    header.appendChild(avatar);
                }
                
                const username = document.createElement('span');
                username.className = 'username';
                username.textContent = message.username;
                header.appendChild(username);
                
                const time = document.createElement('span');
                time.className = 'message-time';
                const date = new Date(message.timestamp * 1000);
                time.textContent = date.toLocaleTimeString();
                header.appendChild(time);
                
                messageDiv.appendChild(header);
                
                const content = document.createElement('div');
                content.className = 'message-content';
                content.textContent = message.text;
                messageDiv.appendChild(content);
                
                messageContainer.prepend(messageDiv);
                
                // Limit number of messages to prevent memory issues
                if (messageContainer.children.length > 100) {
                    messageContainer.removeChild(messageContainer.lastChild);
                }
            }
            
            function handleGift(gift) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message gift-message';
                
                const header = document.createElement('div');
                header.className = 'message-header';
                
                if (gift.avatar) {
                    const avatar = document.createElement('img');
                    avatar.className = 'avatar';
                    avatar.src = gift.avatar;
                    avatar.onerror = function() {
                        this.src = 'https://static.hdslb.com/images/member/noface.gif';
                    };
                    header.appendChild(avatar);
                }
                
                const username = document.createElement('span');
                username.className = 'username';
                username.textContent = gift.username;
                header.appendChild(username);
                
                const time = document.createElement('span');
                time.className = 'message-time';
                const date = new Date(gift.timestamp * 1000);
                time.textContent = date.toLocaleTimeString();
                header.appendChild(time);
                
                messageDiv.appendChild(header);
                
                const content = document.createElement('div');
                content.className = 'message-content';
                content.textContent = `${gift.action} ${gift.num} × ${gift.giftName}`;
                messageDiv.appendChild(content);
                
                messageContainer.prepend(messageDiv);
            }
            
            function handleSuperChat(sc) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message super-chat';
                messageDiv.style.backgroundColor = sc.color;
                
                // Adjust text color based on background brightness
                const brightness = getBrightness(sc.color);
                const textColor = brightness > 160 ? '#000' : '#fff';
                
                const header = document.createElement('div');
                header.className = 'message-header';
                
                if (sc.avatar) {
                    const avatar = document.createElement('img');
                    avatar.className = 'avatar';
                    avatar.src = sc.avatar;
                    avatar.onerror = function() {
                        this.src = 'https://static.hdslb.com/images/member/noface.gif';
                    };
                    header.appendChild(avatar);
                }
                
                const username = document.createElement('span');
                username.className = 'username';
                username.textContent = sc.username;
                username.style.color = textColor;
                header.appendChild(username);
                
                const price = document.createElement('span');
                price.style.marginLeft = '10px';
                price.style.color = textColor;
                price.textContent = `¥${sc.price}`;
                header.appendChild(price);
                
                const time = document.createElement('span');
                time.className = 'message-time';
                time.style.color = textColor;
                const remainingTime = Math.floor((sc.endTime - (Date.now() / 1000)) / 60);
                time.textContent = `${remainingTime} mins remaining`;
                header.appendChild(time);
                
                messageDiv.appendChild(header);
                
                const content = document.createElement('div');
                content.className = 'message-content';
                content.textContent = sc.message;
                content.style.color = textColor;
                messageDiv.appendChild(content);
                
                messageContainer.prepend(messageDiv);
            }
            
            function handleUserEnter(user) {
                // Optionally display user enter messages
                if (user.type === 'welcome') {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message entry-message';
                    
                    const content = document.createElement('div');
                    content.className = 'message-content';
                    content.textContent = `Welcome ${user.username}${user.isGuard ? ' (Guard)' : ''}${user.isAdmin ? ' (Admin)' : ''}`;
                    messageDiv.appendChild(content);
                    
                    messageContainer.prepend(messageDiv);
                }
            }
            
            function handleRoomInfo(info) {
                // Update room information display
                roomInfoContainer.innerHTML = '';
                
                if (info.anchor) {
                    const roomInfoDiv = document.createElement('div');
                    roomInfoDiv.className = 'room-info';
                    
                    const avatar = document.createElement('img');
                    avatar.className = 'room-avatar';
                    avatar.src = info.anchor.face;
                    avatar.onerror = function() {
                        this.src = 'https://static.hdslb.com/images/member/noface.gif';
                    };
                    roomInfoDiv.appendChild(avatar);
                    
                    const infoDiv = document.createElement('div');
                    
                    const title = document.createElement('div');
                    title.className = 'room-title';
                    title.textContent = info.title || `Room ${info.roomId}`;
                    infoDiv.appendChild(title);
                    
                    const streamer = document.createElement('div');
                    streamer.textContent = info.anchor.name;
                    infoDiv.appendChild(streamer);
                    
                    const area = document.createElement('div');
                    if (info.area) {
                        area.textContent = `${info.area.parentName} - ${info.area.name}`;
                        infoDiv.appendChild(area);
                    }
                    
                    roomInfoDiv.appendChild(infoDiv);
                    roomInfoContainer.appendChild(roomInfoDiv);
                    
                    const stats = document.createElement('div');
                    stats.className = 'stats';
                    
                    const onlineDiv = document.createElement('div');
                    onlineDiv.className = 'stat-item';
                    onlineDiv.innerHTML = `<i>👥</i> ${info.online || 0}`;
                    stats.appendChild(onlineDiv);
                    
                    roomInfoContainer.appendChild(stats);
                }
            }
            
            function handleLog(log) {
                const logLine = document.createElement('div');
                logLine.className = `system-log ${log.type}`;
                logLine.textContent = `[${new Date().toLocaleTimeString()}] ${log.message}`;
                
                const systemLog = document.getElementById('systemLog');
                systemLog.appendChild(logLine);
                systemLog.scrollTop = systemLog.scrollHeight;
            }
            
            function handleError(error) {
                handleLog({ type: 'error', message: error.message });
            }
            
            function handleConnection(data) {
                const { connected } = data;
                
                connectBtn.disabled = connected;
                disconnectBtn.disabled = !connected;
                messageInput.disabled = !connected || !cookieInput.value.trim();
                sendBtn.disabled = !connected || !cookieInput.value.trim();
                
                if (connected) {
                    addSystemLog('info', 'Connected to Bilibili live chat');
                } else {
                    addSystemLog('info', 'Disconnected from Bilibili live chat');
                }
            }
            
            function addSystemLog(type, message) {
                const logLine = document.createElement('div');
                logLine.className = `system-log ${type}`;
                logLine.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                
                const systemLog = document.getElementById('systemLog');
                systemLog.appendChild(logLine);
                systemLog.scrollTop = systemLog.scrollHeight;
            }
            
            // Helper function to determine background brightness for text color
            function getBrightness(hexColor) {
                // Remove # if present
                hexColor = hexColor.replace('#', '');
                
                // Parse hex value to RGB
                const r = parseInt(hexColor.substr(0, 2), 16);
                const g = parseInt(hexColor.substr(2, 2), 16);
                const b = parseInt(hexColor.substr(4, 2), 16);
                
                // Calculate perceived brightness using the formula
                // (0.299*R + 0.587*G + 0.114*B)
                return (0.299 * r + 0.587 * g + 0.114 * b);
            }
            
            // Initialize with some system logs
            addSystemLog('info', 'Bilibili Live Chat WebSocket Client initialized');
            addSystemLog('info', 'Enter a room ID and click Connect to start');
        });
    </script>
</body>
</html>